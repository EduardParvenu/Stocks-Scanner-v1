<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        @media (max-width: 600px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            th {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
            }
            td:before {
                position: absolute;
                left: 6px;
                content: attr(data-label);
                font-weight: bold;
            }
        }
    </style>
</head>
<body>
    <h1>Stock Scanner</h1>
    <table id="stockTable">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>% Change</th>
                <th>News Headline</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="3">Loading...</td></tr>
        </tbody>
    </table>
    <p>Master list last updated: <span id="masterTime">Never</span></p>
    <p>Scanner last updated: <span id="scannerTime">Never</span></p>
    <p>Tiingo news last updated: <span id="tiingoTime">Never</span></p>

    <script>
        // Replace these with your actual API keys
        const finnhubKey = "cvab5chr01qshflh8ih0cvab5chr01qshflh8ihg";
        const tiingoKey = "f69a911d466dacc71482ee05dd94f54956c40383";

        // List of 25 diverse stocks across sectors
        const masterList = [
            "AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", // Tech
            "JPM", "V", "MA", "PYPL", // Finance
            "JNJ", "UNH", "PFE", "ABT", // Healthcare
            "PG", "KO", "PEP", // Consumer Goods
            "DIS", "NFLX", "CMCSA", // Media
            "HD", "VZ", // Retail/Telecom
            "ADBE", "INTC", "CSCO", "T" // Software/Telecom
        ];

        let masterQuotes = [];
        let tiingoNewsCache = {};

        // Helper function to fetch data with a delay
        async function fetchWithDelay(url, delayMs) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error(`Fetch error: ${response.status}`);
                    return null;
                }
                const data = await response.json();
                await new Promise(resolve => setTimeout(resolve, delayMs));
                return data;
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                return null;
            }
        }

        // Update master list every 10 minutes with Finnhub quotes
        async function updateMasterList() {
            masterQuotes = [];
            for (const symbol of masterList) {
                const quote = await fetchWithDelay(
                    `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubKey}`,
                    5000 // 5-second delay
                );
                if (quote) {
                    masterQuotes.push({ symbol, ...quote });
                }
            }
            document.getElementById('masterTime').textContent = new Date().toLocaleTimeString();
            console.log("Master list updated");
        }

        // Update scanner every 3 minutes, showing top 5 stocks with news
        async function updateScanner() {
            if (masterQuotes.length === 0) {
                console.log("Master list is empty, skipping scanner update");
                return;
            }
            const results = [];
            for (const quote of masterQuotes) {
                const symbol = quote.symbol;
                const news = await fetchWithDelay(
                    `https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0]}&to=${new Date().toISOString().split('T')[0]}&token=${finnhubKey}`,
                    1000 // 1-second delay
                );
                if (news && news.length > 0) {
                    results.push({ symbol, quote, news: news[0] });
                }
            }
            // Sort by % change and select top 5
            const top5 = results
                .sort((a, b) => ((b.quote.c - b.quote.pc) / b.quote.pc) - ((a.quote.c - a.quote.pc) / a.quote.pc))
                .slice(0, 5);
            renderTable(top5);
            document.getElementById('scannerTime').textContent = new Date().toLocaleTimeString();
            console.log("Scanner updated");
        }

        // Update Tiingo news every hour
        async function updateTiingoNews() {
            for (const symbol of masterList) {
                const data = await fetchWithDelay(
                    `https://api.tiingo.com/tiingo/news?tickers=${symbol}&token=${tiingoKey}`,
                    5000 // 5-second delay
                );
                if (data && data.length > 0) {
                    tiingoNewsCache[symbol] = data[0].title;
                } else {
                    tiingoNewsCache[symbol] = "No Tiingo news";
                }
            }
            document.getElementById('tiingoTime').textContent = new Date().toLocaleTimeString();
            console.log("Tiingo news updated");
        }

        // Render the table with top 5 stocks
        function renderTable(top5) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            if (top5.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No stocks with recent news found.</td></tr>';
                return;
            }
            top5.forEach(item => {
                const symbol = item.symbol;
                const percentChange = ((item.quote.c - item.quote.pc) / item.quote.pc * 100).toFixed(2);
                const headline = item.news.headline || tiingoNewsCache[symbol] || "No recent news";
                const row = `<tr>
                    <td data-label="Symbol">${symbol}</td>
                    <td data-label="% Change">${percentChange}%</td>
                    <td data-label="News Headline">${headline}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        // Initial load
        updateMasterList().then(updateScanner).then(updateTiingoNews);

        // Set intervals for periodic updates
        setInterval(updateMasterList, 10 * 60 * 1000); // Every 10 minutes
        setInterval(updateScanner, 3 * 60 * 1000);     // Every 3 minutes
        setInterval(updateTiingoNews, 60 * 60 * 1000); // Every hour
    </script>
</body>
</html>
